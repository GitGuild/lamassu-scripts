#!/usr/bin/env bash
set -e

if [ "$(whoami)" != "root" ]; then
  echo -e "This script has to be run as \033[1mroot\033[0m user"
  exit 3
fi

echo "Activating geth (Ethereum server wallet)..."

export LOG_FILE=/tmp/install.log
touch $LOG_FILE
chmod 666 $LOG_FILE

ufw allow 30303/tcp >> $LOG_FILE 2>&1 # Ethereum

BIN=$(su lamassu -c "npm bin")
LAMASSU_HOME=~lamassu
SEEDS_DIR="$LAMASSU_HOME/seeds"
SEED_FILE=$SEEDS_DIR/seed.txt
SEED=$(cat $SEED_FILE)
export PASS_FILE=$SEEDS_DIR/geth.txt
$BIN/hkdf geth-pw $SEED > $PASS_FILE
ACCOUNT_STR=$(geth --password $PASS_FILE account new)
export ACCOUNT=$(echo $ACCOUNT_STR | grep -o '{.*}' | tr -d '{}')

su -l lamassu <<EOF
  cd ~

  pm2 start geth -- --fast --rpc --unlock $ACCOUNT --password $PASS_FILE >> $LOG_FILE 2>&1
  pm2 save

  echo "Success. Your main account is 0x$ACCOUNT."
EOF
